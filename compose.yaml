# This is an EXAMPLE of using winvoice-server with Postgres

name: 'winvoice'

configs:
  permissions-model: {file: 'server/permissions/model.conf'}

secrets:
  cors: {file: 'server/cors/'}
  db: {file: 'db/'}
  permissions-policy: {file: 'server/permissions/policy.csv'}
  ssl: {file: 'server/ssl/'}
  ssl-cadir: {file: 'server/ssl-cadir/'}

networks:
  backend: null

volumes:
  db-data: null
  logs: null

services:
  db:
    image: 'postgres'
    user: 'postgres'

    healthcheck:
      test: ['CMD-SHELL', 'pg_isready --dbname "$(cat /run/secrets/db/name.txt)" --username "$(cat /run/secrets/db/user.txt)"']
      interval: '10s'
      timeout: '5s'
      retries: 5
    restart: 'always'

    expose: [5432]
    networks: ['backend']

    environment:
      POSTGRES_DB_FILE: '/run/secrets/db/name.txt'
      POSTGRES_PASSWORD_FILE: '/run/secrets/db/password.txt'
      POSTGRES_USER_FILE: '/run/secrets/db/user.txt'
    secrets:
      - 'db'
    volumes:
      - 'db-data:/var/lib/postgresql/data'

  server:
    image: 'winvoice/server:v0.6.2'
    build: 'https://github.com/Iron-E/winvoice-server.git#v0.6.2'

    depends_on:
      db: {condition: 'service_healthy'}
    healthcheck:
      test: ['CMD-SHELL', 'test $(curl -fsw "%{http_code}" https://localhost:3000) -eq 400 && exit 0 || exit 1']
      interval: '10s'
      timeout: '5s'
      retries: 5
    restart: 'always'

    networks: ['backend']
    ports: ['3000:3000']

    configs:
      - 'permissions-model'
    secrets:
      - 'cors'
      - 'db'
      - 'permissions-policy'
      - 'ssl'
      - source: 'ssl-cadir'
        target: '/etc/ssl/certs'
    volumes:
      - 'logs:$HOME/.local/state/winvoice-server'

    entrypoint: ['/bin/sh', '-c']
    command: >-
        'winvoice-server
        --certificate /run/secrets/ssl/cert.pem --key /run/secrets/ssl/key.pem
        --cors-allow-origin /run/secrets/cors/allow.txt
        --permissions-model /permissions-model --permissions-policy /run/secrets/permissions-policy
        postgres
        --host db --database "$(cat /run/secrets/db/name.txt)"
        --username "$(cat /run/secrets/db/user.txt)" --password "$(cat /run/secrets/db/password.txt)"'
